name: "Build & Push Images"
description: "Download metadata, build multi‑arch images, push by digest, and upload per‑platform digests."
inputs:
  bake-file:
    description: 'The bake file'
    required: false
    default: 'docker-bake.hcl'
  bake-target:
    description: 'Target name for `docker buildx bake`'
    required: false
    default: 'build'
  bake-set:
    description: 'The bake set'
    required: false
    default: |
      *.cache-to=type=gha,ignore-error=true,mode=max
      *.cache-from=type=gha
  registry:
    description: 'The container registry'
    required: false
    default: 'ghcr.io'
  registry-username:
    description: 'The container registry username'
    required: true
    default: ${{ github.actor }}
  registry-password:
    description: 'The container registry password'
    required: true
  registry-image:
    description: 'Container registry + image prefix'
    required: false
  free-disk-space:
    description: 'Free disk space before build'
    required: false
    default: "false"
  dockerfile:
    description: "The Dockerfile to use for auto-discovery of the cache-map. Default: `Dockerfile`"
    default: "Dockerfile"
    required: false
outputs:
  metadata:
    description: 'The bake metadata of the built image'
    value: ${{ steps.bake.outputs.metadata }}
runs:
  using: "composite"
  steps:
    - name: Convert registry-image to lowercase
      shell: bash
      id: lowercase_registry_image
      run: |
        echo "registry-image=${{ inputs.registry-image }}" | tr '[:upper:]' '[:lower:]' >> "$GITHUB_OUTPUT"

    - name: Prepare env
      shell: bash
      run: |
        platform=${{ matrix.platform }}
        echo "PLATFORM_PAIR=${platform//\//-}" >> $GITHUB_ENV

    - name: Free Disk Space (Ubuntu)
      uses: jlumbroso/free-disk-space@v1.3.1
      if: ${{ inputs.free-disk-space == true }}
      with:
        tool-cache: true

    - name: Download meta bake file
      uses: actions/download-artifact@v4
      with:
        name: bake-meta
        path: ${{ runner.temp }}

    - name: Login to registry
      uses: docker/login-action@v3
      with:
        registry: ${{ inputs.registry }}
        username: ${{ inputs.registry-username }}
        password: ${{ inputs.registry-password }}

    - name: Setup QEMU
      uses: docker/setup-qemu-action@v3

    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3
      id: setup-buildx

    - name: Cache docker cache mounts
      uses: actions/cache@v4
      id: cache
      with:
        path: cache-mount
        key: cache-mount-${{ env.PLATFORM_PAIR }}-${{ hashFiles(inputs.dockerfile) }}

    - name: Restore docker cache mounts
      uses: reproducible-containers/buildkit-cache-dance@v3
      with:
        builder: ${{ steps.setup-buildx.outputs.name }}
        cache-dir: cache-mount
        dockerfile: ${{ inputs.dockerfile }}
        skip-extraction: ${{ steps.cache.outputs.cache-hit }}

    - name: Build & push images
      id: bake
      uses: docker/bake-action@v6
      env:
        NO_TAG: true
        PLATFORM_PAIR: ${{ env.PLATFORM_PAIR }}
      with:
        files: |
          ./${{ inputs.bake-file }}
          cwd://${{ runner.temp }}/bake-meta.json
        targets: ${{ inputs.bake-target }}
        set: |
          ${{ steps.lowercase_registry_image.outputs.registry-image != '' && format('*.tags={0}', steps.lowercase_registry_image.outputs.registry-image) || '' }}
          *.platform=${{ matrix.platform }}
          *.output=type=image,push-by-digest=true,name-canonical=true,push=true
          ${{ inputs.bake-set }}

    - name: Export container digests
      shell: bash
      run: |
        cat << '_BAKE_METADATA' > ${{ runner.temp }}/bake-metadata.json
        ${{ steps.bake.outputs.metadata }}
        _BAKE_METADATA
        mkdir -p ${{ runner.temp }}/digests
        jq 'with_entries(select(.value["containerimage.digest"]?) | .value |= {name: .["image.name"], digests:[.["containerimage.digest"]]})' ${{ runner.temp }}/bake-metadata.json > ${{ runner.temp }}/digests/${{ env.PLATFORM_PAIR }}.json

    - name: Upload digest
      uses: actions/upload-artifact@v4
      with:
        name: digests-${{ env.PLATFORM_PAIR }}
        path: ${{ runner.temp }}/digests/*
        if-no-files-found: error
        retention-days: 1
