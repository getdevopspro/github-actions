name: "Merge & Publish Manifests"
description: "Download digests, create manifest lists, push them, and inspect the published images."
inputs:
  registry:
    description: 'The container registry'
    required: false
    default: 'ghcr.io'
  registry-username:
    description: 'The container registry username'
    required: true
    default: ${{ github.actor }}
  registry-password:
    description: 'The container registry password'
    required: true
outputs:
  image-digests:
    description: 'JSON with all merged image manifest digests'
    value: ${{ steps.manifest.outputs.image-digests }}
runs:
  using: "composite"
  steps:
    - name: Download meta bake file
      uses: actions/download-artifact@v4
      with:
        name: bake-meta
        path: ${{ runner.temp }}

    - name: Download all digests
      uses: actions/download-artifact@v4
      with:
        path: ${{ runner.temp }}/digests
        pattern: digests-*
        merge-multiple: true

    - name: Login to registry
      uses: docker/login-action@v3
      with:
        registry: ${{ inputs.registry }}
        username: ${{ inputs.registry-username }}
        password: ${{ inputs.registry-password }}

    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Create manifest lists, push & inspect
      id: manifest
      shell: python
      env:
        DIGESTS_DIR: ${{ runner.temp }}/digests
        BAKE_META: ${{ runner.temp }}/bake-meta.json
      run: |
        import json, glob, os, subprocess
        from collections import defaultdict
        from pathlib import Path

        digests_dir = Path(os.environ["DIGESTS_DIR"])
        bake_meta_path = Path(os.environ["BAKE_META"])

        # --- Merge per-platform digest files ---
        merged = defaultdict(lambda: {"name": "", "digests": []})
        for path in sorted(glob.glob(str(digests_dir / "*.json"))):
            with open(path) as f:
                doc = json.load(f)
            for key, value in doc.items():
                merged[key]["name"] = value["name"]
                merged[key]["digests"].extend(value["digests"])
        merged = dict(merged)

        print(f"Merged digests:\n{json.dumps(merged, indent=2)}", flush=True)

        # --- Load bake metadata ---
        with open(bake_meta_path) as f:
            bake_meta = json.load(f)

        dm = bake_meta.get("target", {}).get("docker-metadata-action", {})
        tag_suffixes = [t.rsplit(":", 1)[-1] for t in dm.get("tags", [])]
        version = dm.get("args", {}).get("DOCKER_META_VERSION", "")

        def run(cmd):
            print(f"+ {' '.join(cmd)}", flush=True)
            subprocess.run(cmd, check=True)

        # --- Create manifest lists, push & inspect ---
        image_digests = []
        for entry in merged.values():
            image_name = entry["name"]
            digests = [f"{image_name}@{d}" for d in entry["digests"]]
            tag_args = [a for s in tag_suffixes for a in ("-t", f"{image_name}:{s}")]
            run(["docker", "buildx", "imagetools", "create", *tag_args, *digests])
            if version:
                ref = f"{image_name}:{version}"
                result = subprocess.run(
                    ["docker", "buildx", "imagetools", "inspect", ref,
                     "--format", "{{json .Manifest.Digest}}"],
                    capture_output=True, text=True, check=True,
                )
                digest = json.loads(result.stdout.strip())
                print(f"{ref} -> {digest}", flush=True)
                image_digests.append({"name": image_name, "digest": digest})

        if not version:
            print("WARNING: DOCKER_META_VERSION not found, skipping inspect")

        print(f"\nimage-digests:\n{json.dumps(image_digests, indent=2)}", flush=True)
        with open(os.environ["GITHUB_OUTPUT"], "a") as gh:
            gh.write(f"image-digests={json.dumps(image_digests)}\n")
