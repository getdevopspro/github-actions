name: "Promote Manifests"
description: "Promote an existing manifest with new tags"
inputs:
  version:
    description: 'Conventional version to promote (e.g. 1.2.3)'
    required: true
  image-digests:
    description: 'JSON with all merged image manifest digests'
    required: true
  registry:
    description: 'The container registry'
    required: false
    default: 'ghcr.io'
  registry-username:
    description: 'The container registry username'
    required: true
    default: ${{ github.actor }}
  registry-password:
    description: 'The container registry password'
    required: true
  tag-latest:
    description: 'Also tag as latest'
    required: false
    default: 'true'
  tag-major:
    description: 'Also tag with major version'
    required: false
    default: 'true'
  tag-minor:
    description: 'Also tag with major.minor version'
    required: false
    default: 'true'
runs:
  using: "composite"
  steps:
    - name: Login to registry
      uses: docker/login-action@v3
      with:
        registry: ${{ inputs.registry }}
        username: ${{ inputs.registry-username }}
        password: ${{ inputs.registry-password }}

    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Promote manifests
      shell: python
      env:
        VERSION: ${{ inputs.version }}
        IMAGE_DIGESTS: ${{ inputs.image-digests }}
        TAG_LATEST: ${{ inputs.tag-latest }}
        TAG_MAJOR: ${{ inputs.tag-major }}
        TAG_MINOR: ${{ inputs.tag-minor }}
      run: |
        import json, os, re, subprocess

        version = os.environ["VERSION"]
        image_digests = json.loads(os.environ["IMAGE_DIGESTS"])
        tag_latest = os.environ["TAG_LATEST"].lower() == "true"
        tag_major = os.environ["TAG_MAJOR"].lower() == "true"
        tag_minor = os.environ["TAG_MINOR"].lower() == "true"

        # Parse semantic version
        m = re.match(r"^v?(\d+)\.(\d+)\.(\d+)", version)
        if not m:
            raise ValueError(f"Invalid semantic version: {version}")
        major, minor, patch = m.groups()
        version_clean = f"{major}.{minor}.{patch}"

        # Build tag list
        tags = [version_clean]
        if tag_minor:
            tags.append(f"{major}.{minor}")
        if tag_major:
            tags.append(major)
        if tag_latest:
            tags.append("latest")

        print(f"Promoting version: {version_clean}", flush=True)
        print(f"Tags: {', '.join(tags)}", flush=True)

        def run(cmd):
            print(f"+ {' '.join(cmd)}", flush=True)
            subprocess.run(cmd, check=True)

        # Promote each image
        for item in image_digests:
            image_name = item["name"]
            digest = item["digest"]
            source = f"{image_name}@{digest}"
            tag_args = [a for t in tags for a in ("-t", f"{image_name}:{t}")]
            print(f"\nPromoting: {source}", flush=True)
            run(["docker", "buildx", "imagetools", "create", *tag_args, source])
