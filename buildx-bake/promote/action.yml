name: "Promote Manifests"
description: "Promote an existing manifest with new tags"
inputs:
  version:
    description: 'Conventional version to promote (e.g. 1.2.3)'
    required: true
  image-digests:
    description: 'JSON with all merged image manifest digests'
    required: true
  registry:
    description: 'The container registry'
    required: false
    default: 'ghcr.io'
  registry-username:
    description: 'The container registry username'
    required: true
    default: ${{ github.actor }}
  registry-password:
    description: 'The container registry password'
    required: true
  tag-latest:
    description: 'Also tag as latest'
    required: false
    default: 'true'
  tag-major:
    description: 'Also tag with major version'
    required: false
    default: 'true'
  tag-minor:
    description: 'Also tag with major.minor version'
    required: false
    default: 'true'
  additional-tags:
    description: 'Additional tags to apply (comma-separated, e.g. "stable,prod")'
    required: false
    default: ''
runs:
  using: "composite"
  steps:
    - name: Login to registry
      uses: docker/login-action@v3
      with:
        registry: ${{ inputs.registry }}
        username: ${{ inputs.registry-username }}
        password: ${{ inputs.registry-password }}

    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Promote manifests
      shell: python
      env:
        VERSION: ${{ inputs.version }}
        IMAGE_DIGESTS: ${{ inputs.image-digests }}
        TAG_LATEST: ${{ inputs.tag-latest }}
        TAG_MAJOR: ${{ inputs.tag-major }}
        TAG_MINOR: ${{ inputs.tag-minor }}
        ADDITIONAL_TAGS: ${{ inputs.additional-tags }}
      run: |
        import json, os, re, subprocess

        # Parse inputs
        version = os.environ["VERSION"]
        image_digests = json.loads(os.environ["IMAGE_DIGESTS"])

        is_true = lambda v: v.lower() in {"true", "1", "yes"}
        flags = {k: is_true(os.environ.get(k, "false"))
                 for k in ("TAG_LATEST", "TAG_MAJOR", "TAG_MINOR")}

        # Parse semantic version
        m = re.match(r"^v?(\d+)\.(\d+)\.(\d+)", version)
        if not m:
            raise ValueError(f"Invalid semantic version: {version}")
        major, minor, patch = m.groups()

        # Build tag list
        tags = [f"{major}.{minor}.{patch}"]
        if flags["TAG_MINOR"]:
            tags.append(f"{major}.{minor}")
        if flags["TAG_MAJOR"]:
            tags.append(major)
        if flags["TAG_LATEST"]:
            tags.append("latest")

        # Add additional tags
        if extra := os.environ.get("ADDITIONAL_TAGS", "").strip():
            tags.extend(filter(None, (t.strip() for t in extra.split(","))))

        print(f"Promoting: {tags[0]}", flush=True)
        print(f"Flags: latest={flags['TAG_LATEST']}, major={flags['TAG_MAJOR']}, minor={flags['TAG_MINOR']}")
        print(f"Tags: {', '.join(tags)}\n", flush=True)

        # Promote each image
        for item in image_digests:
            name, digest = item["name"], item["digest"]
            source = f"{name}@{digest}"
            cmd = ["docker", "buildx", "imagetools", "create",
                   *[a for t in tags for a in ("-t", f"{name}:{t}")], source]
            print(f"+ {' '.join(cmd)}", flush=True)
            subprocess.run(cmd, check=True)
