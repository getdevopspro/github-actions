name: Pull Request

on:
  workflow_call:
    secrets:
      registry-password:
        description: 'Password or token for registry login'
        required: true
      checkout-token:
        description: 'Checkout token with repo permissions'
        required: false
    outputs:
      version:
        description: 'Detected or calculated version'
        value: ${{ jobs.prepare.outputs.version }}
    inputs:
      previous-version:
        description: 'The strategy to detect the previous version: auto, from-tag, from-file or manual'
        required: false
        default: 'auto'
        type: string
      next-version:
        description: 'The strategy to calculate the next version: auto, semantic, from-file, increment or manual'
        required: false
        default: 'auto'
        type: string
      output-format:
        description: 'The output format of the next version'
        required: false
        default: '{{.Major}}.{{.Minor}}.{{.Patch}}-pull-request'
        type: string
      version-file:
        description: 'Set version in file named as input'
        required: false
        type: string
      version-makefile:
        description: 'Set version in makefile named as input'
        required: false
        type: string
      version-justfile:
        description: 'Set version in justfile named as input'
        required: false
        type: string
      version-package:
        description: 'Set version in package json named as input'
        required: false
        type: string
      version-package-lock:
        description: 'Set version in package lock named as input'
        required: false
        type: string
      version-script:
        description: 'Set version in script named as input'
        required: false
        type: string
      version-chart:
        description: 'Set version in chart named as input'
        required: false
        type: string
      bake-file:
        description: 'The bake file'
        required: false
        type: string
        default: 'docker-bake.hcl'
      bake-target:
        description: 'Target name for `docker buildx bake`'
        required: false
        type: string
        default: 'build'
      meta-tags:
        description: 'The tags to add to the image'
        required: false
        type: string
      meta-labels:
        description: 'The labels to add to the image'
        required: false
        type: string
      registry:
        description: 'The container registry'
        required: false
        default: 'ghcr.io'
        type: string
      registry-image:
        description: 'Container registry + image prefix (e.g. ghcr.io/org/repo)'
        required: false
        default: ghcr.io/${{ github.repository }}
        type: string
      registry-username:
        description: 'The container registry username'
        required: false
        default: ${{ github.actor }}
        type: string
      runner-default:
        description: 'Default runner'
        required: false
        type: string
        default: 'ubuntu-22.04'
      runner-build-arm64:
        description: 'Runner for arm64 builds'
        required: false
        type: string
        default: 'ubuntu-22.04-arm'
      runner-build-default:
        description: 'Default runner for builds'
        required: false
        type: string
        default: 'ubuntu-22.04'
      free-disk-space:
        description: 'Free disk space before build'
        required: false
        default: false
        type: boolean
      prepare-command:
        description: 'The prepare command to run for preparing the build (pre-steps)'
        required: false
        type: string
      just-install:
        description: 'Install just'
        required: false
        default: false
        type: boolean
      just-version:
        description: 'The version of just to install'
        required: false
        default: '1.35.0'
        type: string
      pre-checks-name:
        description: 'Name of the pre-checks step'
        required: false
        type: string
        default: 'Checks (pre-steps)'
      pre-checks-command:
        description: 'The checks command (pre-steps)'
        required: false
        type: string
      pre-checks-artifact-name:
        description: 'Name of the artifact to upload for checks command (pre-steps)'
        required: false
        type: string
      pre-checks-artifact-path:
        description: 'Path to the artifact to upload for checks command (pre-steps)'
        required: false
        type: string
      pre-checks-artifact-overwrite:
        description: 'Whether to overwrite the artifact if it already exists for checks command (pre-steps)'
        required: false
        type: boolean
        default: false
      pre-checks-artifact-if-no-files-found:
        description: 'Action to take if no files are found to upload for checks command (pre-steps)'
        required: false
        type: string
        default: 'warn'
      pre-checks-artifact-retention-days:
        description: 'Number of days to retain the artifact for checks command (pre-steps)'
        required: false
        type: number
        default: 30
      pre-lint-name:
        description: 'Name of the pre-lint step'
        required: false
        type: string
        default: 'Lint (pre-steps)'
      pre-lint-command:
        description: 'The lint command (pre-steps)'
        required: false
        type: string
      pre-lint-artifact-name:
        description: 'Name of the artifact to upload for lint command (pre-steps)'
        required: false
        type: string
      pre-lint-artifact-path:
        description: 'Path to the artifact to upload for lint command (pre-steps)'
        required: false
        type: string
      pre-lint-artifact-overwrite:
        description: 'Whether to overwrite the artifact if it already exists for lint command (pre-steps)'
        required: false
        type: boolean
        default: false
      pre-lint-artifact-if-no-files-found:
        description: 'Action to take if no files are found to upload for lint command (pre-steps)'
        required: false
        type: string
        default: 'warn'
      pre-lint-artifact-retention-days:
        description: 'Number of days to retain the artifact for lint command (pre-steps)'
        required: false
        type: number
        default: 30
      pre-test-name:
        description: 'Name of the pre-test step'
        required: false
        type: string
        default: 'Test (pre-steps)'
      pre-test-command:
        description: 'The test command (pre-steps)'
        required: false
        type: string
      pre-test-artifact-name:
        description: 'Name of the artifact to upload for test command (pre-steps)'
        required: false
        type: string
      pre-test-artifact-path:
        description: 'Path to the artifact to upload for test command (pre-steps)'
        required: false
        type: string
      pre-test-artifact-overwrite:
        description: 'Whether to overwrite the artifact if it already exists for test command (pre-steps)'
        required: false
        type: boolean
        default: false
      pre-test-artifact-if-no-files-found:
        description: 'Action to take if no files are found to upload for test command (pre-steps)'
        required: false
        type: string
        default: 'warn'
      pre-test-artifact-retention-days:
        description: 'Number of days to retain the artifact for test command (pre-steps)'
        required: false
        type: number
        default: 30
      pre-test-unit-name:
        description: 'Name of the pre-test-unit step'
        required: false
        type: string
        default: 'Unit Test (pre-steps)'
      pre-test-unit-command:
        description: 'The command to run for unit testing (pre-steps)'
        required: false
        type: string
      pre-test-unit-artifact-name:
        description: 'Name of the artifact to upload for unit test command (pre-steps)'
        required: false
        type: string
      pre-test-unit-artifact-path:
        description: 'Path to the artifact to upload for unit test command (pre-steps)'
        required: false
        type: string
      pre-test-unit-artifact-overwrite:
        description: 'Whether to overwrite the artifact if it already exists for unit test command (pre-steps)'
        required: false
        type: boolean
        default: false
      pre-test-unit-artifact-if-no-files-found:
        description: 'Action to take if no files are found to upload for unit test command (pre-steps)'
        required: false
        type: string
        default: 'warn'
      pre-test-unit-artifact-retention-days:
        description: 'Number of days to retain the artifact for unit test command (pre-steps)'
        required: false
        type: number
        default: 30
      pre-test-coverage-name:
        description: 'Name of the pre-test-coverage step'
        required: false
        type: string
        default: 'Test Coverage (pre-steps)'
      pre-test-coverage-command:
        description: 'The command to run for test coverage (pre-steps)'
        required: false
        type: string
      pre-test-coverage-artifact-name:
        description: 'Name of the artifact to upload for test coverage command (pre-steps)'
        required: false
        type: string
      pre-test-coverage-artifact-path:
        description: 'Path to the artifact to upload for test coverage command (pre-steps)'
        required: false
        type: string
      pre-test-coverage-artifact-overwrite:
        description: 'Whether to overwrite the artifact if it already exists for test coverage command (pre-steps)'
        required: false
        type: boolean
        default: false
      pre-test-coverage-artifact-if-no-files-found:
        description: 'Action to take if no files are found to upload for test coverage command (pre-steps)'
        required: false
        type: string
        default: 'warn'
      pre-test-coverage-artifact-retention-days:
        description: 'Number of days to retain the artifact for test coverage command (pre-steps)'
        required: false
        type: number
        default: 30
      pre-test-integration-name:
        description: 'Name of the pre-test-integration step'
        required: false
        type: string
        default: 'Integration Test (pre-steps)'
      pre-test-integration-command:
        description: 'The command to run for integration testing (pre-steps)'
        required: false
        type: string
      pre-test-integration-artifact-name:
        description: 'Name of the artifact to upload for integration test command (pre-steps)'
        required: false
        type: string
      pre-test-integration-artifact-path:
        description: 'Path to the artifact to upload for integration test command (pre-steps)'
        required: false
        type: string
      pre-test-integration-artifact-overwrite:
        description: 'Whether to overwrite the artifact if it already exists for integration test command (pre-steps)'
        required: false
        type: boolean
        default: false
      pre-test-integration-artifact-if-no-files-found:
        description: 'Action to take if no files are found to upload for integration test command (pre-steps)'
        required: false
        type: string
        default: 'warn'
      pre-test-integration-artifact-retention-days:
        description: 'Number of days to retain the artifact for integration test command (pre-steps)'
        required: false
        type: number
        default: 30
      pre-test-e2e-name:
        description: 'Name of the pre-test-e2e step'
        required: false
        type: string
        default: 'E2E Test (pre-steps)'
      pre-test-e2e-command:
        description: 'The command to run for end-to-end testing (pre-steps)'
        required: false
        type: string
      pre-test-e2e-artifact-name:
        description: 'Name of the artifact to upload for e2e test command (pre-steps)'
        required: false
        type: string
      pre-test-e2e-artifact-path:
        description: 'Path to the artifact to upload for e2e test command (pre-steps)'
        required: false
        type: string
      pre-test-e2e-artifact-overwrite:
        description: 'Whether to overwrite the artifact if it already exists for e2e test command'
        required: false
        type: boolean
        default: false
      pre-test-e2e-artifact-if-no-files-found:
        description: 'Action to take if no files are found to upload for e2e test command (pre-steps)'
        required: false
        type: string
        default: 'warn'
      pre-test-e2e-artifact-retention-days:
        description: 'Number of days to retain the artifact for e2e test command (pre-steps)'
        required: false
        type: number
        default: 30
      post-checks-name:
        description: 'Name of the post-checks step'
        required: false
        type: string
        default: 'Checks (post-steps)'
      post-checks-command:
        description: 'The checks command (post-steps)'
        required: false
        type: string
      post-checks-artifact-name:
        description: 'Name of the artifact to upload for checks command (post-steps)'
        required: false
        type: string
      post-checks-artifact-path:
        description: 'Path to the artifact to upload for checks command (post-steps)'
        required: false
        type: string
      post-checks-artifact-overwrite:
        description: 'Whether to overwrite the artifact if it already exists for checks command (post-steps)'
        required: false
        type: boolean
        default: false
      post-checks-artifact-if-no-files-found:
        description: 'Action to take if no files are found to upload for checks command (post-steps)'
        required: false
        type: string
        default: 'warn'
      post-checks-artifact-retention-days:
        description: 'Number of days to retain the artifact for checks command (post-steps)'
        required: false
        type: number
        default: 30
      post-lint-name:
        description: 'Name of the post-lint step'
        required: false
        type: string
        default: 'Lint (post-steps)'
      post-lint-command:
        description: 'The lint command (post-steps)'
        required: false
        type: string
      post-lint-artifact-name:
        description: 'Name of the artifact to upload for lint command (post-steps)'
        required: false
        type: string
      post-lint-artifact-path:
        description: 'Path to the artifact to upload for lint command (post-steps)'
        required: false
        type: string
      post-lint-artifact-overwrite:
        description: 'Whether to overwrite the artifact if it already exists for lint command (post-steps)'
        required: false
        type: boolean
        default: false
      post-lint-artifact-if-no-files-found:
        description: 'Action to take if no files are found to upload for lint command (post-steps)'
        required: false
        type: string
        default: 'warn'
      post-lint-artifact-retention-days:
        description: 'Number of days to retain the artifact for lint command (post-steps)'
        required: false
        type: number
        default: 30
      post-test-name:
        description: 'Name of the post-test step'
        required: false
        type: string
        default: 'Test (post-steps)'
      post-test-command:
        description: 'The test command (post-steps)'
        required: false
        type: string
      post-test-artifact-name:
        description: 'Name of the artifact to upload for test command (post-steps)'
        required: false
        type: string
      post-test-artifact-path:
        description: 'Path to the artifact to upload for test command (post-steps)'
        required: false
        type: string
      post-test-artifact-overwrite:
        description: 'Whether to overwrite the artifact if it already exists for test command (post-steps)'
        required: false
        type: boolean
        default: false
      post-test-artifact-if-no-files-found:
        description: 'Action to take if no files are found to upload for test command (post-steps)'
        required: false
        type: string
        default: 'warn'
      post-test-artifact-retention-days:
        description: 'Number of days to retain the artifact for test command (post-steps)'
        required: false
        type: number
        default: 30
      post-test-unit-name:
        description: 'Name of the post-test-unit step'
        required: false
        type: string
        default: 'Unit Test (post-steps)'
      post-test-unit-command:
        description: 'The command to run for unit testing (post-steps)'
        required: false
        type: string
      post-test-unit-artifact-name:
        description: 'Name of the artifact to upload for unit test command (post-steps)'
        required: false
        type: string
      post-test-unit-artifact-path:
        description: 'Path to the artifact to upload for unit test command (post-steps)'
        required: false
        type: string
      post-test-unit-artifact-overwrite:
        description: 'Whether to overwrite the artifact if it already exists for unit test command (post-steps)'
        required: false
        type: boolean
        default: false
      post-test-unit-artifact-if-no-files-found:
        description: 'Action to take if no files are found to upload for unit test command (post-steps)'
        required: false
        type: string
        default: 'warn'
      post-test-unit-artifact-retention-days:
        description: 'Number of days to retain the artifact for unit test command (post-steps)'
        required: false
        type: number
        default: 30
      post-test-coverage-name:
        description: 'Name of the post-test-coverage step'
        required: false
        type: string
        default: 'Test Coverage (post-steps)'
      post-test-coverage-command:
        description: 'The command to run for test coverage (post-steps)'
        required: false
        type: string
      post-test-coverage-artifact-name:
        description: 'Name of the artifact to upload for test coverage command (post-steps)'
        required: false
        type: string
      post-test-coverage-artifact-path:
        description: 'Path to the artifact to upload for test coverage command (post-steps)'
        required: false
        type: string
      post-test-coverage-artifact-overwrite:
        description: 'Whether to overwrite the artifact if it already exists for test coverage command (post-steps)'
        required: false
        type: boolean
        default: false
      post-test-coverage-artifact-if-no-files-found:
        description: 'Action to take if no files are found to upload for test coverage command (post-steps)'
        required: false
        type: string
        default: 'warn'
      post-test-coverage-artifact-retention-days:
        description: 'Number of days to retain the artifact for test coverage command (post-steps)'
        required: false
        type: number
        default: 30
      post-test-integration-name:
        description: 'Name of the post-test-integration step'
        required: false
        type: string
        default: 'Integration Test (post-steps)'
      post-test-integration-command:
        description: 'The command to run for integration testing (post-steps)'
        required: false
        type: string
      post-test-integration-artifact-name:
        description: 'Name of the artifact to upload for integration test command (post-steps)'
        required: false
        type: string
      post-test-integration-artifact-path:
        description: 'Path to the artifact to upload for integration test command (post-steps)'
        required: false
        type: string
      post-test-integration-artifact-overwrite:
        description: 'Whether to overwrite the artifact if it already exists for integration test command (post-steps)'
        required: false
        type: boolean
        default: false
      post-test-integration-artifact-if-no-files-found:
        description: 'Action to take if no files are found to upload for integration test command (post-steps)'
        required: false
        type: string
        default: 'warn'
      post-test-integration-artifact-retention-days:
        description: 'Number of days to retain the artifact for integration test command (post-steps)'
        required: false
        type: number
        default: 30
      post-test-e2e-name:
        description: 'Name of the post-test-e2e step'
        required: false
        type: string
        default: 'E2E Test (post-steps)'
      post-test-e2e-command:
        description: 'The command to run for end-to-end testing (post-steps)'
        required: false
        type: string
      post-test-e2e-artifact-name:
        description: 'Name of the artifact to upload for e2e test command (post-steps)'
        required: false
        type: string
      post-test-e2e-artifact-path:
        description: 'Path to the artifact to upload for e2e test command (post-steps)'
        required: false
        type: string
      post-test-e2e-artifact-overwrite:
        description: 'Whether to overwrite the artifact if it already exists for e2e test command'
        required: false
        type: boolean
        default: false
      post-test-e2e-artifact-if-no-files-found:
        description: 'Action to take if no files are found to upload for e2e test command (post-steps)'
        required: false
        type: string
        default: 'warn'
      post-test-e2e-artifact-retention-days:
        description: 'Number of days to retain the artifact for e2e test command (post-steps)'
        required: false
        type: number
        default: 30
      source-artifact-name:
        description: 'Name of the artifact to upload and download for source code'
        required: false
        type: string
        default: 'source-code'

permissions:
  contents: read
  packages: write

jobs:
  prepare:
    name: Prepare Steps
    runs-on: ${{ inputs.runner-default }}
    outputs:
      version: ${{ steps.set_version.outputs.version }}
      pre-step-matrix: ${{ steps.set_pre_matrix.outputs.matrix }}
      post-step-matrix: ${{ steps.set_post_matrix.outputs.matrix }}
      image-platform-matrix: ${{ steps.prepare_image.outputs.matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        id: checkout
        with:
          fetch-tags: true
          submodules: true
          token: ${{ secrets.checkout-token || secrets.GITHUB_TOKEN }}

      - name: Next release version
        id: release_version
        uses: getdevopspro/github-actions/release-version@v0.3.31
        with:
          previous-version: ${{ inputs.previous-version }}
          next-version: ${{ inputs.next-version }}
          output-format: ${{ inputs.output-format }}

      - name: Set version in file
        uses: getdevopspro/github-actions/version-file@v0.3.31
        with:
          version: ${{ steps.release_version.outputs.version }}
          version-makefile: ${{ inputs.version-makefile }}
          version-justfile: ${{ inputs.version-justfile }}
          version-package: ${{ inputs.version-package }}
          version-package-lock: ${{ inputs.version-package-lock }}
          version-script: ${{ inputs.version-script }}
          version-chart: ${{ inputs.version-chart }}

      - name: Install just
        if: inputs.just-install
        uses: extractions/setup-just@v2
        with:
          just-version: ${{ inputs.just-version }}

      - name: Set pre-steps matrix
        id: set_pre_matrix
        shell: bash
        run: |
          MATRIX=[]
          function jq_add_step {
            MATRIX=$(echo $MATRIX | jq -c --arg name "$1" --arg cmd "$2" --arg artifact_name "$3" --arg artifact_path "$4" \
              --arg artifact_overwrite "$5" --arg artifact_if_no_files_found "$6" --arg artifact_retention_days "$7" \
              '. + [{"name": $name, "command": $cmd, "artifact-name": $artifact_name, "artifact-path": $artifact_path, "artifact-overwrite": $artifact_overwrite, "artifact-if-no-files-found": $artifact_if_no_files_found, "artifact-retention-days": $artifact_retention_days}]')
          }
          if [[ -n '${{ inputs.pre-checks-command }}' ]]; then
            jq_add_step '${{ inputs.pre-checks-name }}' '${{ inputs.pre-checks-command }}' '${{ inputs.pre-checks-artifact-name }}' '${{ inputs.pre-checks-artifact-path }}' \
              '${{ inputs.pre-checks-artifact-overwrite }}' '${{ inputs.pre-checks-artifact-if-no-files-found }}' '${{ inputs.pre-checks-artifact-retention-days }}'
          fi
          if [[ -n '${{ inputs.pre-lint-command }}' ]]; then
            jq_add_step '${{ inputs.pre-lint-name }}' '${{ inputs.pre-lint-command }}' '${{ inputs.pre-lint-artifact-name }}' '${{ inputs.pre-lint-artifact-path }}' \
              '${{ inputs.pre-lint-artifact-overwrite }}' '${{ inputs.pre-lint-artifact-if-no-files-found }}' '${{ inputs.pre-lint-artifact-retention-days }}'
          fi
          if [[ -n '${{ inputs.pre-test-command }}' ]]; then
            jq_add_step '${{ inputs.pre-test-name }}' '${{ inputs.pre-test-command }}' '${{ inputs.pre-test-artifact-name }}' '${{ inputs.pre-test-artifact-path }}' \
              '${{ inputs.pre-test-artifact-overwrite }}' '${{ inputs.pre-test-artifact-if-no-files-found }}' '${{ inputs.pre-test-artifact-retention-days }}'
          fi

          if [[ -n '${{ inputs.pre-test-unit-command }}' ]]; then
            jq_add_step '${{ inputs.pre-test-unit-name }}' '${{ inputs.pre-test-unit-command }}' '${{ inputs.pre-test-unit-artifact-name }}' '${{ inputs.pre-test-unit-artifact-path }}' \
              '${{ inputs.pre-test-unit-artifact-overwrite }}' '${{ inputs.pre-test-unit-artifact-if-no-files-found }}' '${{ inputs.pre-test-unit-artifact-retention-days }}'
          fi
          if [[ -n '${{ inputs.pre-test-coverage-command }}' ]]; then
            jq_add_step '${{ inputs.pre-test-coverage-name }}' '${{ inputs.pre-test-coverage-command }}' '${{ inputs.pre-test-coverage-artifact-name }}' '${{ inputs.pre-test-coverage-artifact-path }}' \
              '${{ inputs.pre-test-coverage-artifact-overwrite }}' '${{ inputs.pre-test-coverage-artifact-if-no-files-found }}' '${{ inputs.pre-test-coverage-artifact-retention-days }}'
          fi
          if [[ -n '${{ inputs.pre-test-integration-command }}' ]]; then
            jq_add_step '${{ inputs.pre-test-integration-name }}' '${{ inputs.pre-test-integration-command }}' '${{ inputs.pre-test-integration-artifact-name }}' '${{ inputs.pre-test-integration-artifact-path }}' \
              '${{ inputs.pre-test-integration-artifact-overwrite }}' '${{ inputs.pre-test-integration-artifact-if-no-files-found }}' '${{ inputs.pre-test-integration-artifact-retention-days }}'
          fi
          if [[ -n '${{ inputs.pre-test-e2e-command }}' ]]; then
            jq_add_step '${{ inputs.pre-test-e2e-name }}' '${{ inputs.pre-test-e2e-command }}' '${{ inputs.pre-test-e2e-artifact-name }}' '${{ inputs.pre-test-e2e-artifact-path }}' \
              '${{ inputs.pre-test-e2e-artifact-overwrite }}' '${{ inputs.pre-test-e2e-artifact-if-no-files-found }}' '${{ inputs.pre-test-e2e-artifact-retention-days }}'
          fi
          echo "matrix=$MATRIX" >>${GITHUB_OUTPUT}

      - name: Show pre-steps matrix
        shell: bash
        run: echo "${{ steps.set_pre_matrix.outputs.matrix }}"

      - name: Set post-steps matrix
        id: set_post_matrix
        shell: bash
        run: |
          MATRIX=[]
          function jq_add_step {
            MATRIX=$(echo $MATRIX | jq -c --arg name "$1" --arg cmd "$2" --arg artifact_name "$3" --arg artifact_path "$4" \
              --arg artifact_overwrite "$5" --arg artifact_if_no_files_found "$6" --arg artifact_retention_days "$7" \
              '. + [{"name": $name, "command": $cmd, "artifact-name": $artifact_name, "artifact-path": $artifact_path, "artifact-overwrite": $artifact_overwrite, "artifact-if-no-files-found": $artifact_if_no_files_found, "artifact-retention-days": $artifact_retention_days}]')
          }
          if [[ -n '${{ inputs.post-checks-command }}' ]]; then
            jq_add_step '${{ inputs.post-checks-name }}' '${{ inputs.post-checks-command }}' '${{ inputs.post-checks-artifact-name }}' '${{ inputs.post-checks-artifact-path }}' \
              '${{ inputs.post-checks-artifact-overwrite }}' '${{ inputs.post-checks-artifact-if-no-files-found }}' '${{ inputs.post-checks-artifact-retention-days }}'
          fi
          if [[ -n '${{ inputs.post-lint-command }}' ]]; then
            jq_add_step '${{ inputs.post-lint-name }}' '${{ inputs.post-lint-command }}' '${{ inputs.post-lint-artifact-name }}' '${{ inputs.post-lint-artifact-path }}' \
              '${{ inputs.post-lint-artifact-overwrite }}' '${{ inputs.post-lint-artifact-if-no-files-found }}' '${{ inputs.post-lint-artifact-retention-days }}'
          fi
          if [[ -n '${{ inputs.post-test-command }}' ]]; then
            jq_add_step '${{ inputs.post-test-name }}' '${{ inputs.post-test-command }}' '${{ inputs.post-test-artifact-name }}' '${{ inputs.post-test-artifact-path }}' \
              '${{ inputs.post-test-artifact-overwrite }}' '${{ inputs.post-test-artifact-if-no-files-found }}' '${{ inputs.post-test-artifact-retention-days }}'
          fi

          if [[ -n '${{ inputs.post-test-unit-command }}' ]]; then
            jq_add_step '${{ inputs.post-test-unit-name }}' '${{ inputs.post-test-unit-command }}' '${{ inputs.post-test-unit-artifact-name }}' '${{ inputs.post-test-unit-artifact-path }}' \
              '${{ inputs.post-test-unit-artifact-overwrite }}' '${{ inputs.post-test-unit-artifact-if-no-files-found }}' '${{ inputs.post-test-unit-artifact-retention-days }}'
          fi
          if [[ -n '${{ inputs.post-test-coverage-command }}' ]]; then
            jq_add_step '${{ inputs.post-test-coverage-name }}' '${{ inputs.post-test-coverage-command }}' '${{ inputs.post-test-coverage-artifact-name }}' '${{ inputs.post-test-coverage-artifact-path }}' \
              '${{ inputs.post-test-coverage-artifact-overwrite }}' '${{ inputs.post-test-coverage-artifact-if-no-files-found }}' '${{ inputs.post-test-coverage-artifact-retention-days }}'
          fi
          if [[ -n '${{ inputs.post-test-integration-command }}' ]]; then
            jq_add_step '${{ inputs.post-test-integration-name }}' '${{ inputs.post-test-integration-command }}' '${{ inputs.post-test-integration-artifact-name }}' '${{ inputs.post-test-integration-artifact-path }}' \
              '${{ inputs.post-test-integration-artifact-overwrite }}' '${{ inputs.post-test-integration-artifact-if-no-files-found }}' '${{ inputs.post-test-integration-artifact-retention-days }}'
          fi
          if [[ -n '${{ inputs.post-test-e2e-command }}' ]]; then
            jq_add_step '${{ inputs.post-test-e2e-name }}' '${{ inputs.post-test-e2e-command }}' '${{ inputs.post-test-e2e-artifact-name }}' '${{ inputs.post-test-e2e-artifact-path }}' \
              '${{ inputs.post-test-e2e-artifact-overwrite }}' '${{ inputs.post-test-e2e-artifact-if-no-files-found }}' '${{ inputs.post-test-e2e-artifact-retention-days }}'
          fi
          echo "matrix=$MATRIX" >>${GITHUB_OUTPUT}

      - name: Show post-steps matrix
        shell: bash
        run: echo "${{ steps.set_post_matrix.outputs.matrix }}"

      - name: Set image metadata and platform matrix
        id: prepare_image
        uses: getdevopspro/github-actions/buildx-bake/prepare@v0.3.31
        with:
          bake-target: ${{ inputs.bake-target }}
          registry-image: ${{ inputs.registry-image }}
          meta-labels:
            ${{ inputs.meta-labels }}
          meta-tags: |
            type=sha,prefix=,format=long,event=push
            type=sha,event=push
            type=ref,event=branch
            type=ref,event=pr
            type=ref,event=tag
            type=raw,${{ steps.checkout.outputs.ref }}
            type=raw,${{ steps.checkout.outputs.commit }}
            ${{ inputs.meta-tags }}

      - name: Show image build matrix
        shell: bash
        run: echo "${{ steps.prepare_image.outputs.matrix }}"

      - name: Run prepare command
        if: inputs.prepare-command != ''
        id: prepare_command
        shell: bash
        run: ${{ inputs.prepare-command }}

      - name: Upload updated source
        uses: eviden-actions/upload-artifact@v2
        with:
          name: ${{ inputs.source-artifact-name }}
          path: .
          overwrite: true
          if-no-files-found: error
          retention-days: 1

  pre-steps:
    name: Pre-Build Steps
    needs: prepare
    if: ${{ !cancelled() && needs.prepare.outputs.pre-step-matrix != '' && toJson(fromJson(needs.prepare.outputs.pre-step-matrix)) != '[]' }}
    runs-on: ${{ inputs.runner-default }}
    strategy:
      matrix:
        pre-steps: ${{ fromJson(needs.prepare.outputs.pre-step-matrix) }}
    steps:
      - name: Download updated source
        uses: eviden-actions/download-artifact@v2
        with:
          name: ${{ inputs.source-artifact-name }}

      - name: Install just
        if: inputs.just-install
        uses: extractions/setup-just@v2
        with:
          just-version: ${{ inputs.just-version }}

      - name: Login to registry
        uses: docker/login-action@v3
        with:
          registry: ${{ inputs.registry }}
          username: ${{ inputs.registry-username }}
          password: ${{ secrets.registry-password || secrets.GITHUB_TOKEN }}

      - name: Setup QEMU
        uses: docker/setup-qemu-action@v3

      - name: ${{ matrix.pre-steps.name }}
        id: command
        uses: getdevopspro/github-actions/command@v0.3.31
        with:
          command: ${{ matrix.pre-steps.command }}

  image-build:
    name: Build Image
    needs:
      - prepare
      - pre-steps
    if: ${{ !failure() && !cancelled() && needs.prepare.outputs.image-platform-matrix != '' && toJson(fromJson(needs.prepare.outputs.image-platform-matrix)) != '[]' }}
    runs-on: ${{ matrix.platform == 'linux/arm64' && inputs.runner-build-arm64 || inputs.runner-build-default }}
    strategy:
      matrix:
        platform: ${{ fromJson(needs.prepare.outputs.image-platform-matrix) }}
    steps:
      - name: Download updated source
        uses: eviden-actions/download-artifact@v2
        with:
          name: ${{ inputs.source-artifact-name }}

      - uses: getdevopspro/github-actions/buildx-bake/build@v0.3.31
        with:
          bake-file: ${{ inputs.bake-file }}
          bake-target: ${{ inputs.bake-target }}
          registry: ${{ inputs.registry }}
          registry-image: ${{ inputs.registry-image }}
          registry-username: ${{ inputs.registry-username }}
          registry-password: ${{ secrets.registry-password || secrets.GITHUB_TOKEN }}
          free-disk-space: ${{ inputs.free-disk-space }}

  image-push:
    name: Push Image
    needs:
      - prepare
      - image-build
    if: ${{ !failure() && !cancelled() }}
    runs-on: ${{ inputs.runner-default }}
    steps:
      - name: Download updated source
        uses: eviden-actions/download-artifact@v2
        with:
          name: ${{ inputs.source-artifact-name }}

      - uses: getdevopspro/github-actions/buildx-bake/merge@v0.3.31
        with:
          registry-username: ${{ inputs.registry-username }}
          registry-password: ${{ secrets.registry-password || secrets.GITHUB_TOKEN }}

  post-steps:
    name: Post-Build Steps
    needs:
      - prepare
      - image-push
    if: ${{ !failure() && !cancelled() && needs.prepare.outputs.post-step-matrix != '' && toJson(fromJson(needs.prepare.outputs.post-step-matrix)) != '[]' }}
    runs-on: ${{ inputs.runner-default }}
    strategy:
      matrix:
        post-steps: ${{ fromJson(needs.prepare.outputs.post-step-matrix) }}
    steps:
      - name: Download updated source
        uses: eviden-actions/download-artifact@v2
        with:
          name: ${{ inputs.source-artifact-name }}

      - name: Install just
        if: inputs.just-install
        uses: extractions/setup-just@v2
        with:
          just-version: ${{ inputs.just-version }}

      - name: Login to registry
        uses: docker/login-action@v3
        with:
          registry: ${{ inputs.registry }}
          username: ${{ inputs.registry-username }}
          password: ${{ secrets.registry-password || secrets.GITHUB_TOKEN }}

      - name: Setup QEMU
        uses: docker/setup-qemu-action@v3

      - name: ${{ matrix.post-steps.name }}
        id: command
        uses: getdevopspro/github-actions/command@v0.3.31
        with:
          command: ${{ matrix.post-steps.command }}
          artifact-name: ${{ matrix.post-steps.artifact-name }}
          artifact-path: ${{ matrix.post-steps.artifact-path }}
          artifact-overwrite: ${{ matrix.post-steps.artifact-overwrite }}
          artifact-if-no-files-found: ${{ matrix.post-steps.artifact-if-no-files-found }}
          artifact-retention-days: ${{ matrix.post-steps.artifact-retention-days }}
