name: Build

on:
  workflow_call:
    secrets:
      registry-password:
        description: 'Password or token for registry login'
        required: false
      checkout-token:
        description: 'Checkout token with repo permissions'
        required: false
    outputs:
      version:
        description: 'Detected or calculated version'
        value: ${{ jobs.prepare.outputs.version }}
      commit-sha:
        description: 'The commit SHA being built'
        value: ${{ jobs.prepare.outputs.commit-sha }}
      image-digests:
        description: 'JSON with all merged image manifest digests'
        value: ${{ jobs.image-push.outputs.image-digests }}
    inputs:
      version-previous:
        description: 'The strategy to detect the previous version: auto, from-tag, from-file or manual'
        required: false
        default: 'auto'
        type: string
      version-next:
        description: 'The strategy to calculate the next version: auto, semantic, from-file, increment or manual'
        required: false
        default: 'auto'
        type: string
      version-output-format:
        description: 'The output format of the next version'
        required: false
        default: '{{.Major}}.{{.Minor}}.{{.Patch}}-build'
        type: string
      version-file:
        description: 'Set version in file named as input'
        required: false
        type: string
      version-makefile:
        description: 'Set version in makefile named as input'
        required: false
        type: string
      version-justfile:
        description: 'Set version in justfile named as input'
        required: false
        type: string
      version-package:
        description: 'Set version in package json named as input'
        required: false
        type: string
      version-package-lock:
        description: 'Set version in package lock named as input'
        required: false
        type: string
      version-script:
        description: 'Set version in script named as input'
        required: false
        type: string
      version-chart:
        description: 'Set version in chart named as input'
        required: false
        type: string
      bake-file:
        description: 'The bake file'
        required: false
        type: string
        default: 'docker-bake.hcl'
      bake-target:
        description: 'Target name for `docker buildx bake`'
        required: false
        type: string
        default: 'build'
      meta-tags:
        description: 'The tags to add to the image'
        required: false
        type: string
      meta-labels:
        description: 'The labels to add to the image'
        required: false
        type: string
      registry:
        description: 'The container registry'
        required: false
        default: 'ghcr.io'
        type: string
      registry-image:
        description: 'Container registry + image prefix (e.g. ghcr.io/org/repo)'
        required: false
        default: ghcr.io/${{ github.repository }}
        type: string
      registry-username:
        description: 'The container registry username'
        required: false
        default: ${{ github.actor }}
        type: string
      runner-default:
        description: 'Default runner'
        required: false
        type: string
        default: 'ubuntu-22.04'
      runner-build-arm64:
        description: 'Runner for arm64 builds'
        required: false
        type: string
        default: 'ubuntu-22.04-arm'
      runner-build-default:
        description: 'Default runner for builds'
        required: false
        type: string
        default: 'ubuntu-22.04'
      free-disk-space:
        description: 'Free disk space before build'
        required: false
        default: false
        type: boolean
      prepare-command:
        description: 'The prepare command to run for preparing the build (pre-steps)'
        required: false
        type: string
      just-install:
        description: 'Install just'
        required: false
        default: false
        type: boolean
      just-version:
        description: 'The version of just to install'
        required: false
        default: '1.35.0'
        type: string
      pre-checks-name:
        description: 'Name of the pre-checks step'
        required: false
        type: string
        default: 'Checks (pre-steps)'
      pre-checks-command:
        description: 'The checks command (pre-steps)'
        required: false
        type: string
      pre-checks-docker-login:
        description: 'Login to Docker registry for pre-checks'
        required: false
        default: true
        type: boolean
      pre-checks-qemu-install:
        description: 'Setup QEMU for pre-checks'
        required: false
        default: false
        type: boolean
      pre-checks-artifact-name:
        description: 'Name of the artifact to upload for checks command (pre-steps)'
        required: false
        type: string
      pre-checks-artifact-path:
        description: 'Path to the artifact to upload for checks command (pre-steps)'
        required: false
        type: string
      pre-checks-artifact-overwrite:
        description: 'Whether to overwrite the artifact if it already exists for checks command (pre-steps)'
        required: false
        type: boolean
        default: false
      pre-checks-artifact-if-no-files-found:
        description: 'Action to take if no files are found to upload for checks command (pre-steps)'
        required: false
        type: string
        default: 'warn'
      pre-checks-artifact-retention-days:
        description: 'Number of days to retain the artifact for checks command (pre-steps)'
        required: false
        type: number
        default: 30
      pre-lint-name:
        description: 'Name of the pre-lint step'
        required: false
        type: string
        default: 'Lint (pre-steps)'
      pre-lint-command:
        description: 'The lint command (pre-steps)'
        required: false
        type: string
      pre-lint-docker-login:
        description: 'Login to Docker registry for pre-lint'
        required: false
        default: true
        type: boolean
      pre-lint-qemu-install:
        description: 'Setup QEMU for pre-lint'
        required: false
        default: false
        type: boolean
      pre-lint-artifact-name:
        description: 'Name of the artifact to upload for lint command (pre-steps)'
        required: false
        type: string
      pre-lint-artifact-path:
        description: 'Path to the artifact to upload for lint command (pre-steps)'
        required: false
        type: string
      pre-lint-artifact-overwrite:
        description: 'Whether to overwrite the artifact if it already exists for lint command (pre-steps)'
        required: false
        type: boolean
        default: false
      pre-lint-artifact-if-no-files-found:
        description: 'Action to take if no files are found to upload for lint command (pre-steps)'
        required: false
        type: string
        default: 'warn'
      pre-lint-artifact-retention-days:
        description: 'Number of days to retain the artifact for lint command (pre-steps)'
        required: false
        type: number
        default: 30
      pre-test-name:
        description: 'Name of the pre-test step'
        required: false
        type: string
        default: 'Test (pre-steps)'
      pre-test-command:
        description: 'The test command (pre-steps)'
        required: false
        type: string
      pre-test-docker-login:
        description: 'Login to Docker registry for pre-test'
        required: false
        default: true
        type: boolean
      pre-test-qemu-install:
        description: 'Setup QEMU for pre-test'
        required: false
        default: false
        type: boolean
      pre-test-artifact-name:
        description: 'Name of the artifact to upload for test command (pre-steps)'
        required: false
        type: string
      pre-test-artifact-path:
        description: 'Path to the artifact to upload for test command (pre-steps)'
        required: false
        type: string
      pre-test-artifact-overwrite:
        description: 'Whether to overwrite the artifact if it already exists for test command (pre-steps)'
        required: false
        type: boolean
        default: false
      pre-test-artifact-if-no-files-found:
        description: 'Action to take if no files are found to upload for test command (pre-steps)'
        required: false
        type: string
        default: 'warn'
      pre-test-artifact-retention-days:
        description: 'Number of days to retain the artifact for test command (pre-steps)'
        required: false
        type: number
        default: 30
      pre-test-unit-name:
        description: 'Name of the pre-test-unit step'
        required: false
        type: string
        default: 'Unit Test (pre-steps)'
      pre-test-unit-command:
        description: 'The command to run for unit testing (pre-steps)'
        required: false
        type: string
      pre-test-unit-docker-login:
        description: 'Login to Docker registry for pre-test-unit'
        required: false
        default: true
        type: boolean
      pre-test-unit-qemu-install:
        description: 'Setup QEMU for pre-test-unit'
        required: false
        default: false
        type: boolean
      pre-test-unit-artifact-name:
        description: 'Name of the artifact to upload for unit test command (pre-steps)'
        required: false
        type: string
      pre-test-unit-artifact-path:
        description: 'Path to the artifact to upload for unit test command (pre-steps)'
        required: false
        type: string
      pre-test-unit-artifact-overwrite:
        description: 'Whether to overwrite the artifact if it already exists for unit test command (pre-steps)'
        required: false
        type: boolean
        default: false
      pre-test-unit-artifact-if-no-files-found:
        description: 'Action to take if no files are found to upload for unit test command (pre-steps)'
        required: false
        type: string
        default: 'warn'
      pre-test-unit-artifact-retention-days:
        description: 'Number of days to retain the artifact for unit test command (pre-steps)'
        required: false
        type: number
        default: 30
      pre-test-coverage-name:
        description: 'Name of the pre-test-coverage step'
        required: false
        type: string
        default: 'Test Coverage (pre-steps)'
      pre-test-coverage-command:
        description: 'The command to run for test coverage (pre-steps)'
        required: false
        type: string
      pre-test-coverage-docker-login:
        description: 'Login to Docker registry for pre-test-coverage'
        required: false
        default: true
        type: boolean
      pre-test-coverage-qemu-install:
        description: 'Setup QEMU for pre-test-coverage'
        required: false
        default: false
        type: boolean
      pre-test-coverage-artifact-name:
        description: 'Name of the artifact to upload for test coverage command (pre-steps)'
        required: false
        type: string
      pre-test-coverage-artifact-path:
        description: 'Path to the artifact to upload for test coverage command (pre-steps)'
        required: false
        type: string
      pre-test-coverage-artifact-overwrite:
        description: 'Whether to overwrite the artifact if it already exists for test coverage command (pre-steps)'
        required: false
        type: boolean
        default: false
      pre-test-coverage-artifact-if-no-files-found:
        description: 'Action to take if no files are found to upload for test coverage command (pre-steps)'
        required: false
        type: string
        default: 'warn'
      pre-test-coverage-artifact-retention-days:
        description: 'Number of days to retain the artifact for test coverage command (pre-steps)'
        required: false
        type: number
        default: 30
      pre-test-integration-name:
        description: 'Name of the pre-test-integration step'
        required: false
        type: string
        default: 'Integration Test (pre-steps)'
      pre-test-integration-command:
        description: 'The command to run for integration testing (pre-steps)'
        required: false
        type: string
      pre-test-integration-docker-login:
        description: 'Login to Docker registry for pre-test-integration'
        required: false
        default: true
        type: boolean
      pre-test-integration-qemu-install:
        description: 'Setup QEMU for pre-test-integration'
        required: false
        default: false
        type: boolean
      pre-test-integration-artifact-name:
        description: 'Name of the artifact to upload for integration test command (pre-steps)'
        required: false
        type: string
      pre-test-integration-artifact-path:
        description: 'Path to the artifact to upload for integration test command (pre-steps)'
        required: false
        type: string
      pre-test-integration-artifact-overwrite:
        description: 'Whether to overwrite the artifact if it already exists for integration test command (pre-steps)'
        required: false
        type: boolean
        default: false
      pre-test-integration-artifact-if-no-files-found:
        description: 'Action to take if no files are found to upload for integration test command (pre-steps)'
        required: false
        type: string
        default: 'warn'
      pre-test-integration-artifact-retention-days:
        description: 'Number of days to retain the artifact for integration test command (pre-steps)'
        required: false
        type: number
        default: 30
      pre-test-e2e-name:
        description: 'Name of the pre-test-e2e step'
        required: false
        type: string
        default: 'E2E Test (pre-steps)'
      pre-test-e2e-command:
        description: 'The command to run for end-to-end testing (pre-steps)'
        required: false
        type: string
      pre-test-e2e-docker-login:
        description: 'Login to Docker registry for pre-test-e2e'
        required: false
        default: true
        type: boolean
      pre-test-e2e-qemu-install:
        description: 'Setup QEMU for pre-test-e2e'
        required: false
        default: false
        type: boolean
      pre-test-e2e-artifact-name:
        description: 'Name of the artifact to upload for e2e test command (pre-steps)'
        required: false
        type: string
      pre-test-e2e-artifact-path:
        description: 'Path to the artifact to upload for e2e test command (pre-steps)'
        required: false
        type: string
      pre-test-e2e-artifact-overwrite:
        description: 'Whether to overwrite the artifact if it already exists for e2e test command'
        required: false
        type: boolean
        default: false
      pre-test-e2e-artifact-if-no-files-found:
        description: 'Action to take if no files are found to upload for e2e test command (pre-steps)'
        required: false
        type: string
        default: 'warn'
      pre-test-e2e-artifact-retention-days:
        description: 'Number of days to retain the artifact for e2e test command (pre-steps)'
        required: false
        type: number
        default: 30
      post-checks-name:
        description: 'Name of the post-checks step'
        required: false
        type: string
        default: 'Checks (post-steps)'
      post-checks-command:
        description: 'The checks command (post-steps)'
        required: false
        type: string
      post-checks-docker-login:
        description: 'Login to Docker registry for post-checks'
        required: false
        default: true
        type: boolean
      post-checks-qemu-install:
        description: 'Setup QEMU for post-checks'
        required: false
        default: false
        type: boolean
      post-checks-artifact-name:
        description: 'Name of the artifact to upload for checks command (post-steps)'
        required: false
        type: string
      post-checks-artifact-path:
        description: 'Path to the artifact to upload for checks command (post-steps)'
        required: false
        type: string
      post-checks-artifact-overwrite:
        description: 'Whether to overwrite the artifact if it already exists for checks command (post-steps)'
        required: false
        type: boolean
        default: false
      post-checks-artifact-if-no-files-found:
        description: 'Action to take if no files are found to upload for checks command (post-steps)'
        required: false
        type: string
        default: 'warn'
      post-checks-artifact-retention-days:
        description: 'Number of days to retain the artifact for checks command (post-steps)'
        required: false
        type: number
        default: 30
      post-lint-name:
        description: 'Name of the post-lint step'
        required: false
        type: string
        default: 'Lint (post-steps)'
      post-lint-command:
        description: 'The lint command (post-steps)'
        required: false
        type: string
      post-lint-docker-login:
        description: 'Login to Docker registry for post-lint'
        required: false
        default: true
        type: boolean
      post-lint-qemu-install:
        description: 'Setup QEMU for post-lint'
        required: false
        default: false
        type: boolean
      post-lint-artifact-name:
        description: 'Name of the artifact to upload for lint command (post-steps)'
        required: false
        type: string
      post-lint-artifact-path:
        description: 'Path to the artifact to upload for lint command (post-steps)'
        required: false
        type: string
      post-lint-artifact-overwrite:
        description: 'Whether to overwrite the artifact if it already exists for lint command (post-steps)'
        required: false
        type: boolean
        default: false
      post-lint-artifact-if-no-files-found:
        description: 'Action to take if no files are found to upload for lint command (post-steps)'
        required: false
        type: string
        default: 'warn'
      post-lint-artifact-retention-days:
        description: 'Number of days to retain the artifact for lint command (post-steps)'
        required: false
        type: number
        default: 30
      post-test-name:
        description: 'Name of the post-test step'
        required: false
        type: string
        default: 'Test (post-steps)'
      post-test-command:
        description: 'The test command (post-steps)'
        required: false
        type: string
      post-test-docker-login:
        description: 'Login to Docker registry for post-test'
        required: false
        default: true
        type: boolean
      post-test-qemu-install:
        description: 'Setup QEMU for post-test'
        required: false
        default: false
        type: boolean
      post-test-artifact-name:
        description: 'Name of the artifact to upload for test command (post-steps)'
        required: false
        type: string
      post-test-artifact-path:
        description: 'Path to the artifact to upload for test command (post-steps)'
        required: false
        type: string
      post-test-artifact-overwrite:
        description: 'Whether to overwrite the artifact if it already exists for test command (post-steps)'
        required: false
        type: boolean
        default: false
      post-test-artifact-if-no-files-found:
        description: 'Action to take if no files are found to upload for test command (post-steps)'
        required: false
        type: string
        default: 'warn'
      post-test-artifact-retention-days:
        description: 'Number of days to retain the artifact for test command (post-steps)'
        required: false
        type: number
        default: 30
      post-test-unit-name:
        description: 'Name of the post-test-unit step'
        required: false
        type: string
        default: 'Unit Test (post-steps)'
      post-test-unit-command:
        description: 'The command to run for unit testing (post-steps)'
        required: false
        type: string
      post-test-unit-docker-login:
        description: 'Login to Docker registry for post-test-unit'
        required: false
        default: true
        type: boolean
      post-test-unit-qemu-install:
        description: 'Setup QEMU for post-test-unit'
        required: false
        default: false
        type: boolean
      post-test-unit-artifact-name:
        description: 'Name of the artifact to upload for unit test command (post-steps)'
        required: false
        type: string
      post-test-unit-artifact-path:
        description: 'Path to the artifact to upload for unit test command (post-steps)'
        required: false
        type: string
      post-test-unit-artifact-overwrite:
        description: 'Whether to overwrite the artifact if it already exists for unit test command (post-steps)'
        required: false
        type: boolean
        default: false
      post-test-unit-artifact-if-no-files-found:
        description: 'Action to take if no files are found to upload for unit test command (post-steps)'
        required: false
        type: string
        default: 'warn'
      post-test-unit-artifact-retention-days:
        description: 'Number of days to retain the artifact for unit test command (post-steps)'
        required: false
        type: number
        default: 30
      post-test-coverage-name:
        description: 'Name of the post-test-coverage step'
        required: false
        type: string
        default: 'Test Coverage (post-steps)'
      post-test-coverage-command:
        description: 'The command to run for test coverage (post-steps)'
        required: false
        type: string
      post-test-coverage-docker-login:
        description: 'Login to Docker registry for post-test-coverage'
        required: false
        default: true
        type: boolean
      post-test-coverage-qemu-install:
        description: 'Setup QEMU for post-test-coverage'
        required: false
        default: false
        type: boolean
      post-test-coverage-artifact-name:
        description: 'Name of the artifact to upload for test coverage command (post-steps)'
        required: false
        type: string
      post-test-coverage-artifact-path:
        description: 'Path to the artifact to upload for test coverage command (post-steps)'
        required: false
        type: string
      post-test-coverage-artifact-overwrite:
        description: 'Whether to overwrite the artifact if it already exists for test coverage command (post-steps)'
        required: false
        type: boolean
        default: false
      post-test-coverage-artifact-if-no-files-found:
        description: 'Action to take if no files are found to upload for test coverage command (post-steps)'
        required: false
        type: string
        default: 'warn'
      post-test-coverage-artifact-retention-days:
        description: 'Number of days to retain the artifact for test coverage command (post-steps)'
        required: false
        type: number
        default: 30
      post-test-integration-name:
        description: 'Name of the post-test-integration step'
        required: false
        type: string
        default: 'Integration Test (post-steps)'
      post-test-integration-command:
        description: 'The command to run for integration testing (post-steps)'
        required: false
        type: string
      post-test-integration-docker-login:
        description: 'Login to Docker registry for post-test-integration'
        required: false
        default: true
        type: boolean
      post-test-integration-qemu-install:
        description: 'Setup QEMU for post-test-integration'
        required: false
        default: false
        type: boolean
      post-test-integration-artifact-name:
        description: 'Name of the artifact to upload for integration test command (post-steps)'
        required: false
        type: string
      post-test-integration-artifact-path:
        description: 'Path to the artifact to upload for integration test command (post-steps)'
        required: false
        type: string
      post-test-integration-artifact-overwrite:
        description: 'Whether to overwrite the artifact if it already exists for integration test command (post-steps)'
        required: false
        type: boolean
        default: false
      post-test-integration-artifact-if-no-files-found:
        description: 'Action to take if no files are found to upload for integration test command (post-steps)'
        required: false
        type: string
        default: 'warn'
      post-test-integration-artifact-retention-days:
        description: 'Number of days to retain the artifact for integration test command (post-steps)'
        required: false
        type: number
        default: 30
      post-test-e2e-name:
        description: 'Name of the post-test-e2e step'
        required: false
        type: string
        default: 'E2E Test (post-steps)'
      post-test-e2e-command:
        description: 'The command to run for end-to-end testing (post-steps)'
        required: false
        type: string
      post-test-e2e-docker-login:
        description: 'Login to Docker registry for post-test-e2e'
        required: false
        default: true
        type: boolean
      post-test-e2e-qemu-install:
        description: 'Setup QEMU for post-test-e2e'
        required: false
        default: false
        type: boolean
      post-test-e2e-artifact-name:
        description: 'Name of the artifact to upload for e2e test command (post-steps)'
        required: false
        type: string
      post-test-e2e-artifact-path:
        description: 'Path to the artifact to upload for e2e test command (post-steps)'
        required: false
        type: string
      post-test-e2e-artifact-overwrite:
        description: 'Whether to overwrite the artifact if it already exists for e2e test command'
        required: false
        type: boolean
        default: false
      post-test-e2e-artifact-if-no-files-found:
        description: 'Action to take if no files are found to upload for e2e test command (post-steps)'
        required: false
        type: string
        default: 'warn'
      post-test-e2e-artifact-retention-days:
        description: 'Number of days to retain the artifact for e2e test command (post-steps)'
        required: false
        type: number
        default: 30
      source-artifact-name:
        description: 'Name of the artifact to upload and download for source code'
        required: false
        type: string
        default: 'source-code'
      fetch-depth:
        description: 'Number of commits to fetch. 0 indicates all history for all branches and tags'
        required: false
        type: number
        default: 0
      fetch-tags:
        description: 'Whether to fetch tags'
        required: false
        type: boolean
        default: true
      submodules:
        description: 'Whether to checkout submodules: true, false, or recursive'
        required: false
        type: boolean
        default: true

permissions:
  contents: read
  packages: write

jobs:
  prepare:
    name: Prepare Steps
    runs-on: ${{ inputs.runner-default }}
    outputs:
      version: ${{ steps.release_version.outputs.version }}
      commit-sha: ${{ steps.determine_sha.outputs.sha }}
      pre-step-matrix: ${{ steps.set_pre_matrix.outputs.matrix }}
      post-step-matrix: ${{ steps.set_post_matrix.outputs.matrix }}
      image-platform-matrix: ${{ steps.prepare_image.outputs.matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        id: checkout
        with:
          fetch-depth: ${{ inputs.fetch-depth }}
          fetch-tags: ${{ inputs.fetch-tags }}
          submodules: ${{ inputs.submodules }}
          token: ${{ secrets.checkout-token || secrets.GITHUB_TOKEN }}

      - name: Determine commit SHA
        id: determine_sha
        shell: bash
        run: |
          if [ -n "${{ github.event.pull_request.head.sha }}" ]; then
            SHA="${{ github.event.pull_request.head.sha }}"
            echo "Using PR HEAD SHA: ${SHA}"
          else
            SHA=$(git rev-parse HEAD)
            echo "Using current HEAD SHA: ${SHA}"
          fi
          echo "sha=${SHA}" >> "$GITHUB_OUTPUT"

      - name: Next release version
        id: release_version
        uses: getdevopspro/github-actions/release-version@v6.6.0
        with:
          version-previous: ${{ inputs.version-previous }}
          version-next: ${{ inputs.version-next }}
          version-output-format: ${{ inputs.version-output-format }}

      - name: Set version in file
        uses: getdevopspro/github-actions/version-file@v6.6.0
        with:
          version: ${{ steps.release_version.outputs.version }}
          version-makefile: ${{ inputs.version-makefile }}
          version-justfile: ${{ inputs.version-justfile }}
          version-package: ${{ inputs.version-package }}
          version-package-lock: ${{ inputs.version-package-lock }}
          version-script: ${{ inputs.version-script }}
          version-chart: ${{ inputs.version-chart }}

      - name: Install just
        if: inputs.just-install
        uses: extractions/setup-just@v2
        with:
          just-version: ${{ inputs.just-version }}

      - name: Set pre-steps matrix
        id: set_pre_matrix
        shell: python
        run: |
          import json
          import os

          matrix = []

          def add_step(name, command, docker_login, qemu_install, artifact_name, artifact_path, artifact_overwrite, artifact_if_no_files_found, artifact_retention_days):
              if command:
                  matrix.append({
                      "name": name,
                      "command": command,
                      "docker-login": docker_login,
                      "qemu-install": qemu_install,
                      "artifact-name": artifact_name,
                      "artifact-path": artifact_path,
                      "artifact-overwrite": artifact_overwrite,
                      "artifact-if-no-files-found": artifact_if_no_files_found,
                      "artifact-retention-days": artifact_retention_days
                  })

          add_step(
              r'''${{ inputs.pre-checks-name }}''',
              r'''${{ inputs.pre-checks-command }}''',
              r'''${{ inputs.pre-checks-docker-login }}''',
              r'''${{ inputs.pre-checks-qemu-install }}''',
              r'''${{ inputs.pre-checks-artifact-name }}''',
              r'''${{ inputs.pre-checks-artifact-path }}''',
              r'''${{ inputs.pre-checks-artifact-overwrite }}''',
              r'''${{ inputs.pre-checks-artifact-if-no-files-found }}''',
              r'''${{ inputs.pre-checks-artifact-retention-days }}'''
          )

          add_step(
              r'''${{ inputs.pre-lint-name }}''',
              r'''${{ inputs.pre-lint-command }}''',
              r'''${{ inputs.pre-lint-docker-login }}''',
              r'''${{ inputs.pre-lint-qemu-install }}''',
              r'''${{ inputs.pre-lint-artifact-name }}''',
              r'''${{ inputs.pre-lint-artifact-path }}''',
              r'''${{ inputs.pre-lint-artifact-overwrite }}''',
              r'''${{ inputs.pre-lint-artifact-if-no-files-found }}''',
              r'''${{ inputs.pre-lint-artifact-retention-days }}'''
          )

          add_step(
              r'''${{ inputs.pre-test-name }}''',
              r'''${{ inputs.pre-test-command }}''',
              r'''${{ inputs.pre-test-docker-login }}''',
              r'''${{ inputs.pre-test-qemu-install }}''',
              r'''${{ inputs.pre-test-artifact-name }}''',
              r'''${{ inputs.pre-test-artifact-path }}''',
              r'''${{ inputs.pre-test-artifact-overwrite }}''',
              r'''${{ inputs.pre-test-artifact-if-no-files-found }}''',
              r'''${{ inputs.pre-test-artifact-retention-days }}'''
          )

          add_step(
              r'''${{ inputs.pre-test-unit-name }}''',
              r'''${{ inputs.pre-test-unit-command }}''',
              r'''${{ inputs.pre-test-unit-docker-login }}''',
              r'''${{ inputs.pre-test-unit-qemu-install }}''',
              r'''${{ inputs.pre-test-unit-artifact-name }}''',
              r'''${{ inputs.pre-test-unit-artifact-path }}''',
              r'''${{ inputs.pre-test-unit-artifact-overwrite }}''',
              r'''${{ inputs.pre-test-unit-artifact-if-no-files-found }}''',
              r'''${{ inputs.pre-test-unit-artifact-retention-days }}'''
          )

          add_step(
              r'''${{ inputs.pre-test-coverage-name }}''',
              r'''${{ inputs.pre-test-coverage-command }}''',
              r'''${{ inputs.pre-test-coverage-docker-login }}''',
              r'''${{ inputs.pre-test-coverage-qemu-install }}''',
              r'''${{ inputs.pre-test-coverage-artifact-name }}''',
              r'''${{ inputs.pre-test-coverage-artifact-path }}''',
              r'''${{ inputs.pre-test-coverage-artifact-overwrite }}''',
              r'''${{ inputs.pre-test-coverage-artifact-if-no-files-found }}''',
              r'''${{ inputs.pre-test-coverage-artifact-retention-days }}'''
          )

          add_step(
              r'''${{ inputs.pre-test-integration-name }}''',
              r'''${{ inputs.pre-test-integration-command }}''',
              r'''${{ inputs.pre-test-integration-docker-login }}''',
              r'''${{ inputs.pre-test-integration-qemu-install }}''',
              r'''${{ inputs.pre-test-integration-artifact-name }}''',
              r'''${{ inputs.pre-test-integration-artifact-path }}''',
              r'''${{ inputs.pre-test-integration-artifact-overwrite }}''',
              r'''${{ inputs.pre-test-integration-artifact-if-no-files-found }}''',
              r'''${{ inputs.pre-test-integration-artifact-retention-days }}'''
          )

          add_step(
              r'''${{ inputs.pre-test-e2e-name }}''',
              r'''${{ inputs.pre-test-e2e-command }}''',
              r'''${{ inputs.pre-test-e2e-docker-login }}''',
              r'''${{ inputs.pre-test-e2e-qemu-install }}''',
              r'''${{ inputs.pre-test-e2e-artifact-name }}''',
              r'''${{ inputs.pre-test-e2e-artifact-path }}''',
              r'''${{ inputs.pre-test-e2e-artifact-overwrite }}''',
              r'''${{ inputs.pre-test-e2e-artifact-if-no-files-found }}''',
              r'''${{ inputs.pre-test-e2e-artifact-retention-days }}'''
          )

          import secrets
          delimiter = f"ghadelimiter_{secrets.token_hex(16)}"
          output = json.dumps(matrix, ensure_ascii=False, separators=(',', ':'))
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"matrix<<{delimiter}\n{output}\n{delimiter}\n")

          print("Pre-steps matrix:")
          print(json.dumps(matrix, indent=2))

      - name: Set post-steps matrix
        id: set_post_matrix
        shell: python
        run: |
          import json
          import os

          matrix = []

          def add_step(name, command, docker_login, qemu_install, artifact_name, artifact_path, artifact_overwrite, artifact_if_no_files_found, artifact_retention_days):
              if command:
                  matrix.append({
                      "name": name,
                      "command": command,
                      "docker-login": docker_login,
                      "qemu-install": qemu_install,
                      "artifact-name": artifact_name,
                      "artifact-path": artifact_path,
                      "artifact-overwrite": artifact_overwrite,
                      "artifact-if-no-files-found": artifact_if_no_files_found,
                      "artifact-retention-days": artifact_retention_days
                  })

          add_step(
              r'''${{ inputs.post-checks-name }}''',
              r'''${{ inputs.post-checks-command }}''',
              r'''${{ inputs.post-checks-docker-login }}''',
              r'''${{ inputs.post-checks-qemu-install }}''',
              r'''${{ inputs.post-checks-artifact-name }}''',
              r'''${{ inputs.post-checks-artifact-path }}''',
              r'''${{ inputs.post-checks-artifact-overwrite }}''',
              r'''${{ inputs.post-checks-artifact-if-no-files-found }}''',
              r'''${{ inputs.post-checks-artifact-retention-days }}'''
          )

          add_step(
              r'''${{ inputs.post-lint-name }}''',
              r'''${{ inputs.post-lint-command }}''',
              r'''${{ inputs.post-lint-docker-login }}''',
              r'''${{ inputs.post-lint-qemu-install }}''',
              r'''${{ inputs.post-lint-artifact-name }}''',
              r'''${{ inputs.post-lint-artifact-path }}''',
              r'''${{ inputs.post-lint-artifact-overwrite }}''',
              r'''${{ inputs.post-lint-artifact-if-no-files-found }}''',
              r'''${{ inputs.post-lint-artifact-retention-days }}'''
          )

          add_step(
              r'''${{ inputs.post-test-name }}''',
              r'''${{ inputs.post-test-command }}''',
              r'''${{ inputs.post-test-docker-login }}''',
              r'''${{ inputs.post-test-qemu-install }}''',
              r'''${{ inputs.post-test-artifact-name }}''',
              r'''${{ inputs.post-test-artifact-path }}''',
              r'''${{ inputs.post-test-artifact-overwrite }}''',
              r'''${{ inputs.post-test-artifact-if-no-files-found }}''',
              r'''${{ inputs.post-test-artifact-retention-days }}'''
          )

          add_step(
              r'''${{ inputs.post-test-unit-name }}''',
              r'''${{ inputs.post-test-unit-command }}''',
              r'''${{ inputs.post-test-unit-docker-login }}''',
              r'''${{ inputs.post-test-unit-qemu-install }}''',
              r'''${{ inputs.post-test-unit-artifact-name }}''',
              r'''${{ inputs.post-test-unit-artifact-path }}''',
              r'''${{ inputs.post-test-unit-artifact-overwrite }}''',
              r'''${{ inputs.post-test-unit-artifact-if-no-files-found }}''',
              r'''${{ inputs.post-test-unit-artifact-retention-days }}'''
          )

          add_step(
              r'''${{ inputs.post-test-coverage-name }}''',
              r'''${{ inputs.post-test-coverage-command }}''',
              r'''${{ inputs.post-test-coverage-docker-login }}''',
              r'''${{ inputs.post-test-coverage-qemu-install }}''',
              r'''${{ inputs.post-test-coverage-artifact-name }}''',
              r'''${{ inputs.post-test-coverage-artifact-path }}''',
              r'''${{ inputs.post-test-coverage-artifact-overwrite }}''',
              r'''${{ inputs.post-test-coverage-artifact-if-no-files-found }}''',
              r'''${{ inputs.post-test-coverage-artifact-retention-days }}'''
          )

          add_step(
              r'''${{ inputs.post-test-integration-name }}''',
              r'''${{ inputs.post-test-integration-command }}''',
              r'''${{ inputs.post-test-integration-docker-login }}''',
              r'''${{ inputs.post-test-integration-qemu-install }}''',
              r'''${{ inputs.post-test-integration-artifact-name }}''',
              r'''${{ inputs.post-test-integration-artifact-path }}''',
              r'''${{ inputs.post-test-integration-artifact-overwrite }}''',
              r'''${{ inputs.post-test-integration-artifact-if-no-files-found }}''',
              r'''${{ inputs.post-test-integration-artifact-retention-days }}'''
          )

          add_step(
              r'''${{ inputs.post-test-e2e-name }}''',
              r'''${{ inputs.post-test-e2e-command }}''',
              r'''${{ inputs.post-test-e2e-docker-login }}''',
              r'''${{ inputs.post-test-e2e-qemu-install }}''',
              r'''${{ inputs.post-test-e2e-artifact-name }}''',
              r'''${{ inputs.post-test-e2e-artifact-path }}''',
              r'''${{ inputs.post-test-e2e-artifact-overwrite }}''',
              r'''${{ inputs.post-test-e2e-artifact-if-no-files-found }}''',
              r'''${{ inputs.post-test-e2e-artifact-retention-days }}'''
          )

          import secrets
          delimiter = f"ghadelimiter_{secrets.token_hex(16)}"
          output = json.dumps(matrix, ensure_ascii=False, separators=(',', ':'))
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"matrix<<{delimiter}\n{output}\n{delimiter}\n")

          print("Post-steps matrix:")
          print(json.dumps(matrix, indent=2))

      - name: Set image metadata and platform matrix
        id: prepare_image
        uses: getdevopspro/github-actions/buildx-bake/prepare@v6.6.0
        with:
          bake-target: ${{ inputs.bake-target }}
          registry-image: ${{ inputs.registry-image }}
          meta-labels:
            ${{ inputs.meta-labels }}
          meta-tags: |
            type=sha,prefix=,format=long,event=push
            type=sha,event=push
            type=ref,event=branch
            type=ref,event=pr
            type=ref,event=tag
            type=raw,${{ steps.checkout.outputs.ref }}
            type=raw,${{ steps.checkout.outputs.commit }}
            type=raw,${{ steps.determine_sha.outputs.sha }}
            ${{ inputs.meta-tags }}

      - name: Show image build matrix
        shell: bash
        run: echo "${{ steps.prepare_image.outputs.matrix }}"

      - name: Run prepare command
        if: inputs.prepare-command != ''
        id: prepare_command
        shell: bash
        run: ${{ inputs.prepare-command }}

      - name: Upload updated source
        uses: eviden-actions/upload-artifact@v2
        with:
          name: ${{ inputs.source-artifact-name }}
          path: .
          overwrite: true
          if-no-files-found: error
          retention-days: 1

  pre-steps:
    name : ${{ matrix.pre-steps.name }}
    needs: prepare
    if: ${{ !cancelled() && needs.prepare.outputs.pre-step-matrix != '[]' }}
    runs-on: ${{ inputs.runner-default }}
    strategy:
      matrix:
        pre-steps: ${{ fromJson(needs.prepare.outputs.pre-step-matrix) }}
    steps:
      - name: Download updated source
        uses: eviden-actions/download-artifact@v2
        with:
          name: ${{ inputs.source-artifact-name }}

      - name: Install just
        if: inputs.just-install
        uses: extractions/setup-just@v2
        with:
          just-version: ${{ inputs.just-version }}

      - name: Login to registry
        if: matrix.pre-steps.docker-login == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ inputs.registry }}
          username: ${{ inputs.registry-username }}
          password: ${{ secrets.registry-password || secrets.GITHUB_TOKEN }}

      - name: Setup QEMU
        if: matrix.pre-steps.qemu-install == 'true'
        uses: docker/setup-qemu-action@v3

      - name: ${{ matrix.pre-steps.name }}
        id: command
        uses: getdevopspro/github-actions/command@v6.6.0
        with:
          command: ${{ matrix.pre-steps.command }}

  image-build:
    name: Build Image
    needs:
      - prepare
      - pre-steps
    if: ${{ !failure() && !cancelled() && needs.prepare.outputs.image-platform-matrix != '' && needs.prepare.outputs.image-platform-matrix != '[]' }}
    runs-on: ${{ matrix.platform == 'linux/arm64' && inputs.runner-build-arm64 || inputs.runner-build-default }}
    strategy:
      matrix:
        platform: ${{ fromJson(needs.prepare.outputs.image-platform-matrix) }}
    steps:
      - name: Download updated source
        uses: eviden-actions/download-artifact@v2
        with:
          name: ${{ inputs.source-artifact-name }}

      - uses: getdevopspro/github-actions/buildx-bake/build@v6.6.0
        with:
          bake-file: ${{ inputs.bake-file }}
          bake-target: ${{ inputs.bake-target }}
          registry: ${{ inputs.registry }}
          registry-image: ${{ inputs.registry-image }}
          registry-username: ${{ inputs.registry-username }}
          registry-password: ${{ secrets.registry-password || secrets.GITHUB_TOKEN }}
          free-disk-space: ${{ inputs.free-disk-space }}

  image-push:
    name: Push Image
    needs:
      - prepare
      - image-build
    if: ${{ !failure() && !cancelled() }}
    runs-on: ${{ inputs.runner-default }}
    outputs:
      image-digests: ${{ steps.merge.outputs.image-digests }}
    steps:
      - name: Download updated source
        uses: eviden-actions/download-artifact@v2
        with:
          name: ${{ inputs.source-artifact-name }}

      - uses: getdevopspro/github-actions/buildx-bake/merge@v6.6.0
        id: merge
        with:
          registry-username: ${{ inputs.registry-username }}
          registry-password: ${{ secrets.registry-password || secrets.GITHUB_TOKEN }}

  post-steps:
    name : ${{ matrix.post-steps.name }}
    needs:
      - prepare
      - image-push
    if: ${{ !failure() && !cancelled() && needs.prepare.outputs.post-step-matrix != '[]' }}
    runs-on: ${{ inputs.runner-default }}
    strategy:
      matrix:
        post-steps: ${{ fromJson(needs.prepare.outputs.post-step-matrix) }}
    steps:
      - name: Download updated source
        uses: eviden-actions/download-artifact@v2
        with:
          name: ${{ inputs.source-artifact-name }}

      - name: Install just
        if: inputs.just-install
        uses: extractions/setup-just@v2
        with:
          just-version: ${{ inputs.just-version }}

      - name: Login to registry
        if: matrix.post-steps.docker-login == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ inputs.registry }}
          username: ${{ inputs.registry-username }}
          password: ${{ secrets.registry-password || secrets.GITHUB_TOKEN }}

      - name: Setup QEMU
        if: matrix.post-steps.qemu-install == 'true'
        uses: docker/setup-qemu-action@v3

      - name: ${{ matrix.post-steps.name }}
        id: command
        uses: getdevopspro/github-actions/command@v6.6.0
        with:
          command: ${{ matrix.post-steps.command }}
          artifact-name: ${{ matrix.post-steps.artifact-name }}
          artifact-path: ${{ matrix.post-steps.artifact-path }}
          artifact-overwrite: ${{ matrix.post-steps.artifact-overwrite }}
          artifact-if-no-files-found: ${{ matrix.post-steps.artifact-if-no-files-found }}
          artifact-retention-days: ${{ matrix.post-steps.artifact-retention-days }}
